# Project: wasma1

## Table of Contents

- [src\bars_viz.rs](#file-bars-viz-rs)
- [src/file.rs](#file-file-rs)

## File: src\bars_viz.rs {#file-bars-viz-rs}

```rust
use web_sys::{SvgElement, SvgRectElement, AnalyserNode};
use wasm_bindgen::{JsValue, JsCast};

pub struct Bar {
    rect: SvgRectElement,
    height: f64,
    velocity: f64,
    k: f64,
    d: f64,
}

pub struct BarsViz {
    bars: Vec<Bar>,
    svg_group: SvgElement,
}

impl BarsViz {
    pub fn new(svg_group: &SvgElement, bin_count: u32) -> Result<Self, JsValue> {
        let document = web_sys::window().unwrap().document().unwrap();
        let mut bars = Vec::with_capacity(bin_count as usize);
        for _ in 0..bin_count {
            let rect = document
                .create_element_ns(Some("http://www.w3.org/2000/svg"), "rect")?
                .dyn_into::<SvgRectElement>()?;
            svg_group.append_child(&rect)?;
            bars.push(Bar {
                rect,
                height: 0.0,
                velocity: 0.0,
                k: 100.0,
                d: 0.9,
            });
        }
        Ok(Self {
            bars,
            svg_group: svg_group.clone(),
        })
    }

    fn update_mood(&mut self, data: &[u8]) -> Result<(), JsValue> {
        let energy = data.iter().map(|&x| x as f64).sum::<f64>() / data.len() as f64;
        let centroid = data
            .iter()
            .enumerate()
            .map(|(i, &x)| i as f64 * x as f64)
            .sum::<f64>()
            / data.iter().map(|&x| x as f64).sum::<f64>();
        for bar in &mut self.bars {
            if energy > 100.0 && centroid < 50.0 {
                bar.k = 150.0;
                bar.d = 0.85;
                bar.rect.set_attribute("fill", "#FF4500")?;
            } else {
                bar.k = 50.0;
                bar.d = 0.95;
                bar.rect.set_attribute("fill", "#00CED1")?;
            }
        }
        Ok(())
    }
}

impl super::Visualization for BarsViz {
    fn update(&mut self, data: &[u8], _svg_group: &SvgElement, _analyser: &AnalyserNode, dt: f64) -> Result<(), JsValue> {
        self.update_mood(data)?;
        let bar_width = 800.0 / self.bars.len() as f64;
        for (i, bar) in self.bars.iter_mut().enumerate() {
            let target = data[i] as f64 * 400.0 / 255.0;
            let force = -bar.k * (bar.height - target);
            bar.velocity += force * dt;
            bar.velocity *= bar.d;
            bar.height += bar.velocity * dt;
            bar.rect.set_attribute("x", &(i as f64 * bar_width).to_string())?;
            bar.rect.set_attribute("y", &(400.0 - bar.height).to_string())?;
            bar.rect.set_attribute("width", &(bar_width * 0.9).to_string())?;
            bar.rect.set_attribute("height", &bar.height.to_string())?;
        }
        Ok(())
    }
}
```

